#!/usr/bin/env ruby

# Compiles the observer script into a single file.
# This is done to make it easier to deploy to the server.
# The script is compiled by recursively inlining all
# require_relative statements.
# The compiled script is then copied to the server.

SOURCE = './bin/l4d2-observer'
TARGET = './tmp/l4d2-observer'
REMOTE = 'bunny@192.168.107:.local/bin/l4d2-observer'

def compile(file, writer)
  File.open(file, 'r') do |reader|
    while (line = reader.gets)
      # require_relative
      if line =~ /^\s*require_relative\s+["'](.*)["']\s*$/
        writer.puts "# START: #{line}"
        dir = File.dirname file
        path = File.expand_path File.join dir, $1
        compile(path, writer)
        writer.puts "# END: #{line}"
      else
        writer.puts line
      end
    end
  end
end

File.open(TARGET, 'w') do |writer|
  compile(SOURCE, writer)
end
system "chmod u+x #{TARGET}"
system "scp #{TARGET} #{REMOTE}"
