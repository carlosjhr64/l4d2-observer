#!/usr/bin/env ruby
# Works on:
#   Version 2.2.1.3 (left4dead2)
#   Network Version 2.1.0.0
#   Exe build: 01:00:42 May 20 2021 (8230) (550)

require 'help_parser'
OPTIONS = HelpParser['0.1.0',<<HELP]
### L4D2 Friendly Fire Observer ###
Usage:
  l4d2-observer [:options+] [<srcds_dir>]
Options:
  --ff=N      \tFF limit
  --exposure=N\tExposure limit
  --kicks=N   \tKicks limit
  --pity=N    \tPity limit
Types:
  N   /^\\d$/
# Notes:
#   srcds_linux defaults to ~/Steam/L4D2-server
HELP
HelpParser.int? :ff, :exposure, :kicks

SERVER_DIR = File.expand_path(OPTIONS.srcds_dir || '~/Steam/L4D2-server')
unless File.exist? SERVER_DIR
  $stderr.puts "#{SERVER_DIR} does not exit."
  exit 64
end
unless File.directory? SERVER_DIR
  $stderr.puts "#{SERVER_DIR} not a directory."
  exit 64
end
unless File.exist? File.join(SERVER_DIR, 'srcds_linux')
  $stderr.puts "srcds_linux not found in #{SERVER_DIR}"
  exit 64
end

EXCESSIVE_LIMIT = OPTIONS.ff       || 3
EXPOSURE_LIMIT  = OPTIONS.exposure || 3
EXCESSIVE_KICKS = OPTIONS.kicks    || 3
PITY_LIMIT      = OPTIONS.pity     || 3

X = '*' # Funky characters replacement
VOTE_INTERVAL = 180
RANDOM_TIME = 60

CACHE = File.expand_path '~/.cache/l4d2-observer'
Dir.mkdir File.expand_path CACHE unless File.exist? CACHE
LOG = File.join CACHE, 'log'
if File.exist? LOG
  log = LOG+'.'+Time.now.strftime('%Y%m%d%H%M%S')
  File.rename(LOG, log)
  system('gzip', log)
end

require_relative '../lib/l4d2-observer.rb'
Dir.chdir SERVER_DIR
ENV['LD_LIBRARY_PATH'] = './bin'
CMD = './srcds_linux -console -game left4dead2 +maxplayers 4 +exec server.cfg +map c1m1_hotel'
L4D2Observer.run
